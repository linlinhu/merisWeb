
<div class="wrapper-content">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>
                    	个人中心
                    </h5>
                </div>
                <div class="ibox-content">
                	 <div class="tabs-container">
	                    <ul class="nav nav-tabs">
	                        <li class="active"><a data-toggle="tab" href="#personalMessageForm-tab" aria-expanded="true">个人资料</a>
	                        </li>
	                        <li class=""><a data-toggle="tab" href="#passwordForm-tab" aria-expanded="false">修改密码</a>
	                        </li>
	                    </ul>
	                    <div class="tab-content">
	                        <div id="personalMessageForm-tab" class="tab-pane active">
	                            <div class="panel-body">
	                                <form method="get" class="form-horizontal" id="personalMessageForm">
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">真实姓名</label>
				                            <div class="col-sm-10">
							                    <input class="form-control id" type="hidden" name="id" value="">
							                    <input class="form-control" type="text" name="realName" >
				                            </div>
				                        </div>
				                        <div class="hr-line-dashed"></div>
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">昵称</label>
				                            <div class="col-sm-10">
							                    <input class="form-control" type="text" name="nickname" >
				                            </div>
				                        </div>
				                        <div class="hr-line-dashed"></div>
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">用户头像</label>
				                            <div class="col-sm-10">
				                            	<div class="upload-input">
				                            		<input class="form-control" type="hidden" name="portrait">
				                            		<i class="fa fa-plus text-navy" onclick="uploadPersonImgResources()"></i>
				                            		<p class="upload-tips">建议上传长宽比例为1:1的图片</p>
				                            	</div>
												<div class="upload-img hide">
													<img class="pro-img"/>
													<span class="removeImg"><i class="fa fa-times"></i></span>
												</div>
				                            </div> 
				                        </div>
				                        <div class="hr-line-dashed"></div>
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">性别</label>
				                            <div class="col-sm-10">
			                                	<label class="radio i-checks inline">
			                                         <input type="radio" value="女" name="gender"> <i></i> 女
			                                     </label>
			                                     <label class="radio i-checks inline">
			                                         <input type="radio"  value="男" name="gender"> <i></i> 男
			                                     </label>
				                            </div>
				                        </div>
				                        <div class="hr-line-dashed"></div>
								        <div class="form-group">
				                            <label class="col-sm-2 control-label">手机号码</label>
				                            <div class="col-sm-10">
							                    <input class="form-control mobile" type="text" name="mobile">
				                            </div>
				                        </div>
				                        <div class="hr-line-dashed"></div>
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">电子邮箱</label>
				                            <div class="col-sm-10">
							                    <input class="form-control email" type="text" name="email">
				                            </div>
				                        </div>
				                        <div class="hr-line-dashed"></div>
				                        <div class="form-group">
				                            <div class="col-sm-4 col-sm-offset-2">
				                                <button class="btn btn-primary" type="submit">保存内容</button>
				                            </div>
				                        </div>
				                    </form>
	                            </div>
	                        </div>
	                        <div id="passwordForm-tab" class="tab-pane">
	                            <div class="panel-body">
	                                <form method="get" class="form-horizontal" id="passwordForm">
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">原密码</label>
				                            <div class="col-sm-10">
				                            	<input class="form-control id" type="hidden" name="id" value="">
							                    <input class="form-control mobile" type="password" name="oldPassword">
				                            </div>
				                        </div>
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">新密码</label>
				                            <div class="col-sm-10">
							                    <input class="form-control mobile" type="password" name="newPassword" id="newPassword">
				                            </div>
				                        </div>
				                        <div class="form-group">
				                            <label class="col-sm-2 control-label">确认新密码</label>
				                            <div class="col-sm-10">
							                    <input class="form-control mobile" type="password" name="newPasswordRepeat">
				                            </div>
				                        </div>
				                        <div class="hr-line-dashed"></div>
				                        <div class="form-group">
				                            <div class="col-sm-4 col-sm-offset-2">
				                                <button class="btn btn-primary" type="submit">确认修改</button>
				                            </div>
				                        </div>
				                    </form>
	                            </div>
	                        </div>
	                    </div>
	                </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/jquery.md5.js"></script>
<script>
//界面数据渲染
$('#personalMessageForm input[name="id"]').val('${personal.data.id}')
$('#passwordForm input[name="id"]').val('${personal.data.id}')
$('#personalMessageForm input[name="realName"]').val('${personal.data.realName}')
$('#personalMessageForm input[name="nickname"]').val('${personal.data.nickname}')
$('#personalMessageForm input[name="mobile"]').val('${personal.data.mobile}')
$('#personalMessageForm input[name="email"]').val('${personal.data.email}')
if(personInfo.gender == '男') {
	$('#personalMessageForm input[value="男"]').attr('checked','')
} else {
	$('#personalMessageForm input[value="女"]').attr('checked','')
}
if(personInfo.portrait && personInfo.portrait.storage){
	showUploadImg(personInfo.portrait,'#personalMessageForm');
}

//单选按钮初始化
$('.i-checks').iCheck({
    checkboxClass: 'icheckbox_square-green',
    radioClass: 'iradio_square-green',
});
//删除头像
$('#personalMessageForm .removeImg').on('click',function(){
	removeUploadImg('#personalMessageForm')
})

function uploadPersonImgResources() {
	var html =  '<div id="uploadInterface" style="z-index:999;">'+
					'<div class="webuploader" id="personImgResourcesUploader">'+
						$('#webuploaderTPL').html() +
				    '</div>'+
				'</div>',
		uploadPics = [];	
				
	layer.open({
		type : 1,
		title : '上传图片资源',
		skin : 'layui-layer-rim', //加上边框
		area : [ '60%', '450px' ], //宽高
		content : '<div class="wrapper-content">' + html + '</div>',
		btn : [ '确定'],
		yes : function(lindex, layero) {
			if (uploadPics.length == 0) {
				layer.msg('请上传张图片后再点击此按钮', {icon: 5});
				return false;
			} else {
				showUploadImg(uploadPics[0],'#personalMessageForm');
				layer.closeAll();
			}
			
		}
	});
	
	CUploadFiles({
		uploaderId: 'personImgResourcesUploader',
		filesType: ['img'],
		uploadUrl: '/file/upload.do',
		fileNumLimit: 1
	}, function(file, response){
		if(response.success){
			uploadPics.push(response.result);
			
		} else {
			layer.msg(response.message?response.message:'上传失败', {icon: 5});
		}
		
	})
}

$('#personalMessageForm').validate({
    rules: {
    	realName: {
            rangelength: [2,20],
            isName: true
        },
        nickname: {
            rangelength: [1,20],
            isName: true
        },
        mobile: {
        	required: true,
            phone: true,
            remote: {
            	url:"person/validateMobile",
                type:"get",
                data:{
                	mobile: function(){return $('#personalMessageForm .mobile').val()},
                	personId: function(){return $('#personalMessageForm .id').val()?$('#personalMessageForm .id').val():''}
                },
                dataFilter: function(data, type) {
                	if (data == 'false'){
                		return true;
                	} else {
                		return false
                	}
         
             	}

            }
        },
        email: {
            isEmail: true,
            remote: {
            	url:"person/validateEmail",
                type:"get",
                data:{
                	email: function(){return $('#personalMessageForm .email').val()},
                	personId: function(){return $('#personalMessageForm .id').val()?$('#personalMessageForm .id').val():''}
                },
                dataFilter: function(data, type) {
                	if (data == 'false'|| data == false){
                		return true;
                	} else {
                		return false
                	}
         
             	}

            }
        }
    },
    messages: {
    	realName: {
            rangelength: icon + "用户姓名输入长度限制为2-20个合法字符",
            isName:icon + "允许输入中文、字母、数字、空格，且不能以空格开始或结尾"
        },
        nickname: {
            rangelength: icon + "用户昵称输入长度限制为1-20个合法字符",
            isName:icon + "允许输入中文、字母、数字、空格，且不能以空格开始或结尾"
        },
        mobile: {
        	required: icon + "请输入手机号码",
            phone: icon + "请输入11位手机号码",
            remote: icon + "手机号码已经注册"
        },
        email: {
            isEmail: icon + "请输入有效的电子邮箱",
            remote: icon + "电子邮箱已经注册"
        }
    },
    submitHandler:function(form){
    	var submitObj =$('#personalMessageForm').serializeObject(),
    		option = {
   	    		url: '${base}personalCenter/saveOrUpdateUserInfo',
   				type: 'POST',
   				data: {}
       		};
    	submitObj.portrait = submitObj.portrait.length>0?JSON.parse(submitObj.portrait):submitObj.portrait;
    	
    	option.data= {
    			jsonStr: JSON.stringify(submitObj)
        };
    	ajaxRequest(option, function(result){
   			if((typeof result) == 'string') {
   				result = JSON.parse(result);
   			}
   			if(result.success){
   				layer.msg('保存成功',{icon: 6});
   				personInfo.realName = submitObj.realName;
   		    	personInfo.nickname = submitObj.nickname;
   		    	personInfo.mobile = submitObj.mobile;
   		    	personInfo.email = submitObj.email;
   		    	personInfo.gender = submitObj.gender;
   		    	personInfo.portrait = submitObj.portrait;
   		    	localStorage.merisWebPersonInfo = JSON.stringify(personInfo)
   		    	if(personInfo.portrait && personInfo.portrait.storage){
   		    		$('#personHeadPortrait').attr('src', personInfo.portrait.storage[2].fileStorageUrl);
   		    	} else {
   		    		$('#personHeadPortrait').attr('src', base + "img/male.png");
   		    	}
   			} else {
   				layer.msg(result.message?'保存失败，原因是'+result.message:'保存失败',{icon: 5});
   			}	
   		})
    } 
});

$('#passwordForm').validate({
    rules: {
        oldPassword: {
        	required: true,
            passwordR: true,
            rangelength:[6,20]
        },
        newPassword: {
        	required: true,
        	noRepeat:true,
            passwordR:true,
            rangelength:[6,20]
        },
        newPasswordRepeat: {
       	 equalTo: '#passwordForm #newPassword'
        }
    },
    messages: {
        oldPassword: {
        	required: icon + "请输入原密码",
            passwordR:icon+'密码格式错误',
            rangelength: icon + "密码长度为6-20" 
        },
        newPassword: {
        	required: icon + "请输入新密码",
        	noRepeat:icon+'新密码不能与原密码相同',
            passwordR:icon+'密码格式错误',
            rangelength: icon + "密码长度为6-20"
        },
        newPasswordRepeat: {
        	equalTo: icon + "两次输入的密码不一致"
        }
    },
    submitHandler:function(form){
    	var submitObj = $('#passwordForm').serializeObject(),
    		option = {
	    		url: '${base}personalCenter/modifyPassword',
				type: 'POST',
				data: {}
    		};
    	
    	option.data = {
    			oldPassword: $.md5(submitObj.oldPassword),
    			newPassword: $.md5(submitObj.newPassword),
    			id:submitObj.id
    	}
    	
   		ajaxRequest(option, function(result){
   			if((typeof result) == 'string') {
   				result = JSON.parse(result);
   			}
   			if(result.success){
   				layer.msg('密码修改成功',{icon: 6});
   				document.getElementById("passwordForm").reset();
   			} else {
   				layer.msg(result.message?'密码修改失败，原因是'+result.message:'密码修改失败',{icon: 5});
   			}	
   		})
    } 
});

$.validator.addMethod("phone",function(value, element, params){  
    var phone = /^1[34578]\d{9}$/;  
    return this.optional(element)||(phone.test(value));  
},"*格式错误");
jQuery.validator.addMethod("isName", function(value, element) {       
    return this.optional(element) || /^[\u4E00-\u9FA5A-Za-z0-9]+[ ]{0,}[\u4E00-\u9FA5A-Za-z0-9]+$/.test(value);       
}, "不符合规则");
$.validator.addMethod("passwordR",function(value,element,params){  
    var passwordR = /^[0-9a-zA-Z]{0,}[0-9a-zA-Z]{1}$/;
    return this.optional(element)||(passwordR.test(value));  
},"*密码格式错误");
$.validator.addMethod("noRepeat",function(value,element,params){  
    var oldPassword = $('#passwordForm input[name="oldPassword"]').val();
    return this.optional(element)||(!(oldPassword.length > 0 && value == oldPassword));
},"*新密码与原密码重复");
</script>